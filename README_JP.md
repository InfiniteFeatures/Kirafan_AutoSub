# Kirafan_AutoSub　チュートリアル（日本語）

## 目的
もともと、日本語のわからない、海外のきらファン勢でもシナリオを楽しめるように、きらファンのシナリオの字幕を便利に外国語字幕に置き換えるツールである。無論、日本語の嘘字幕の生成にも使える  

## 機能
本ツールは以下の６つの機能を持つ
1. 節の自動切出し(Crop)
1. 字幕の分析(Analyse)
1. 字幕の合成(Patch)
1. 節のタイトルの生成(Gensub)
1. ビデオのエンコーディング(Convert) 
1. ビデオ同士の連結(Concat)

## 手順書
使用目的の違いによって、手順も違ってくる
  - メインシナリオ、イベントシナリオの翻訳に使うのなら、以下の手順をすべて読む必要がある  
  - 一節だけの翻訳/嘘字幕の生成なら、以下の**0. インストール**から**5. 字幕の合成(Patch)**まで読めばいい  

#### 0. インストール
- Windowsでは, [ここで](https://drive.google.com/open?id=1ImrdeYRtKIfpD2_1o4TX6B7Vpn3jjijf)最新バージョンの実行ファイル、`Kirafan_Auto.exe`をダウンロード
- LinuxとMacOSでは、本レポジトリをクローンし、以下の依存ライブラリをインストール：
  - python3
  - python依存ライブラリ
    - pillow
    - numpy
    - opencv-python
  - ffmpeg

#### 1. 録画

スマホなりエミュレータなりの録画機能で、きらファンのシナリオを録画する
  - iOSでは[iPhone、iPad、iPod touch で画面を録画する方法](https://support.apple.com/ja-jp/HT207935)を参考
    - アスペクト比は16:9が必須で、4:3では処理できない
    - 念のため、通知、省電力モードをオフにし、音をオンにする
    - デバイスの容量を一定程度確保
  - ゲームアプリを開いて、図書館のシナリオ一覧画面に待機し、録画を開始
  - 録画したい各節を、順序を追ってにクリックし、終了後、録画を停止
    - 各節の第一句が全部流れてから、Autoをオンにし、シナリオの終了を待つ
  - 写真ライブラリで、ビデオが正常に録画されたことを確認
  - ビデオファイルをPCの**空フォルダ**ににコピー、このフォルダの名前に**日本語を含まいこと**を確認

#### 2. 節の自動切出し(Crop)

録画した生ビデオを節ごとに切り出す  
たとえ、1節しかなくても、この手順は必須である  

  - ビデオファイルを`Kirafan_AutoSub.exe`にドラッグ＆ドロップ（以下、ドラッグ＆ドロップのことを、投げると略す）、コマンドプロンプトに表示が出たら、`1`と入力しエンターキーを押す
  すると`<video_name>_seq_video`のフォルダに`0001.mp4`, `0002.mp4`などが生成される
　- 2つ以上ビデオファイルがあるなら、それぞれに対して処理してから、手動で生成されたファイルを、順番に沿って改名し、**一つのフォルダ**にまとめる

#### 3. 字幕の分析(Analyse)

  - 切り出したに`0001.mp4`, `0002.mp4`を含むフォルダを、**フォルダごと**を`Kirafan_AutoSub.exe`に投げる、コマンドプロンプトに表示が出たら、`2`と入力しエンターキーを押す
  - 分析が完了すると，フォルダ`autosub`が生成されて、その中に字幕ファイル`.krfss`が含まれる

#### 4. 字幕の編集(Kirafan_Editor)

  - [ここで](https://github.com/kirafanautodec/Krfss_Editor)Krfss_Editorをダウンロード
  - Krfss_Editorをインストールして開き，フォルダ`autosub`の中の`*.krfss`ファイルを、Krfss_Editorの左上のボックスに投げると、編集できる
  - 編集が完了すると、左上のSaveボタン押して保存する

#### 5. 字幕の合成(Patch)

  - **ビデオを含むフォルダごと**を`Kirafan_AutoSub.exe`に投げて、コマンドプロンプトに表示が出たら、`3`と入力しエンターキーを押す
  - 合成が完了すると、`0001.mp4.autosubed.mp4`などが生成され、空のタイトルファイル`title.txt`も生成される


**一節だけの翻訳/嘘字幕の生成なら、ここでビデオの生成完了**
**ここ以降はメインシナリオ、イベントシナリオの翻訳向け**

#### 6.  節のタイトルの生成(Gensub)

  - テキストエディターで`title.txt`を開き，各節のタイトルを入力し保存
    - タイトルに改行したい場合は、改行せずに`\n`と入力
  - **ビデオを含むフォルダごと**を`Kirafan_AutoSub.exe`に投げて、コマンドプロンプトに表示が出たら、`4`と入力しエンターキーを押す
  - すると、各節のタイトルが生成されるほか、ビデオ連結用の`videolist.txt`も生成される

#### 7. 他のビデオ(OP/ED/CMなど)のエンコーディング(Convert)  

  - 必要に応じ、他のビデオをダウンロード、**英字だけ**の名前にする
    -  ビデオのアスペクト比は16:9でなければならない
  - エンコーディングしたいビデオを`Kirafan_AutoSub.exe`に投げて、コマンドプロンプトに表示が出たら、`6`と入力しエンターキーを押す
  - すると、`<video_name>.cvt.mp4`が生成される、これを**シナリオのビデオのフォルダ**にコピー

#### 8. ビデオ同士の連結(Concat)

  -  `videolist.txt`を開くと
   ```
   file '0001.title.mp4'
   file '0001.mp4.autosubed.mp4'
   file '0002.title.mp4'
   file '0002.mp4.autosubed.mp4'
   ......
   ```
   このようになっている、このファイルは連結順番を記述しているので  
   もし、一節の後にOPを挿入したい場合は、以下のように変更
   ```
   file '0001.title.mp4'
   file '0001.mp4.autosubed.mp4'
   file 'op.mp4.cvt.mp4'
   file '0002.title.mp4'
   file '0002.mp4.autosubed.mp4'
   ......
   ```
  - **ビデオを含むフォルダごと**を`Kirafan_AutoSub.exe`に投げて、コマンドプロンプトに表示が出たら、`5`と入力しエンターキーを押す
  - すると、最終ビデオ`output.mp4`が生成される
