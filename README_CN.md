# Kirafan_AutoSub使用步骤
本文介绍使用Kirafan_AutoSub制作汉化视频的步骤。  
大致分为以下几步：
1. 录屏(Record)
1. 切割(Crop)
1. 提取字幕文件(Analyse)
1. 翻译(Krfss_editor)
1. 打包(Patch)
1. 制作小节标题(Gensub)
1. 根据需要加OPED(Convert) (可选)
1. 连接成一个视频文件(Concat)

## 工具的安装
- 对于使用Windows的大部分用户, 请从[这里](https://drive.google.com/file/d/1XyLcQZ8_95fTh6oWK-5cxKNMgeG-9ifB)下载编译好的最新版工具(v8.1.1)。
下载后解压到一个文件夹里，并确保这个文件夹的路径没有任何**中文或者日文字符**。
后续大部分工作都会在这个文件夹里进行，下文简称**工作目录**。
- 对于使用Linux以MacOS的用户，需要克隆本repo到一个干净的目录下，并安装以下依赖：
    - python3
    - python 依赖库
        - pillow
        - numpy
        - opencv-python
    - ffmpeg  

## 0. 录屏
使用录屏功能，把需要汉化的游戏剧情录成视频文件。
1. 本教程推荐使用iOS自带的录屏功能
1. 将手机设置为可以录屏的状态。
参考：[如何在iPhone、iPad 或iPod touch 上录制屏幕- Apple 支持](https://support.apple.com/zh-cn/HT207935)
1. 确保游戏设备的长宽比为16:9而不是4:3，音量调整到70%，关闭省电模式，关闭**所有通知**，不要选择静音模式。
1. 手机确保有足够的存储空间（一个小时的视频大约2GB，录制前建议留出4GB以上的空间）
1. 打开游戏内图书馆，找到要录制的章节列表，记录要录制的小节数量，及每节名称。

    | No. | 标题 | 编号 |
    | :---: | :---: | :---: |
    | 1 | 今だから | 1 |
    | 2 | 今だから | 2i |
    | 3 | 今だから | 2e |
    | 4 | きんいろに染まる街 | 1 |
    | 5 | きんいろに染まる街 | 4 |
    | …… | …… | …… |
    
    这一步的目的是防止多录、少录，并为将来制作标题做准备。
    
1. 打开录制开关，在游戏中选择各章节，用Auto播放。录制完成后，关闭录制开关。
    * 请在每节的第一句播放完之后，再点右上角箭头→Auto。否则第一句话会被拆分成两半，给翻译造成麻烦。
1. 在相册中确认视频能正常播放，且整段都有声音。如果发现后半段没有声音，则需要重新录制。
    * 视频后半段没有声音，似乎是iOS的问题。
    * 留出充足的存储空间，录制前重启手机，将iOS升级为最新版，似乎可以减少这个现象。
    * 为了降低风险，可以选择分段录制。例如1-5节录一个视频，6-10节录一个视频。但是切割视频之后需要重命名文件。
1. 手机连接到PC，把视频文件复制到PC中。

# 1. 切割(Crop)

1. 把视频文件放在**工作目录**下，确保视频文件名字不含中文字符。
1. 把单个视频文件拖放到`Kirafan_AutoSub.exe`上，等待出现命令提示后输入`1`并回车，即可开始切割视频。如果有多个视频，需要切完一个，再切下一个。
1. 如果切了两个或以上的视频，则需要重命名切割后的文件。
（如果只切了一个视频，则跳过这一步。）
例如：

    | 切割前的文件名 | 切割后的文件名 | 重命名后的文件名 |
    | :------------: | :------------: | :--------------: |
    | 第一段视频.mp4 | 0001.mp4 0002.mp4 0003.mp4 0004.mp4 0005.mp4 | 0001.mp4 0002.mp4 0003.mp4 0004.mp4 0005.mp4 |
    | 第二段视频.mp4 | 0001.mp4 0002.mp4 0003.mp4 0004.mp4 0005.mp4 0006.mp4| 0006.mp4 0007.mp4 0008.mp4 0009.mp4 0010.mp4 0011.mp4 |

1. 把重命名后的文件放到同一个文件夹中，数一下文件数量，确保没有多录、少录。
1. 依次打开视频，同时在手机上打开对应的章节，确认视频的第一句对白和最后一句对白是否正确。
**如果正确，则切割完成，直接进入 3.提取字幕文件**。如果不正确，则需要进行下面的手动切割。
    - 打开原视频，找到要切割的部分，记录要手动切割的**起始时间**和**结束时间**。
起始时间应该是剧情播放前，黑屏的时间。
结束时间应该是剧情播放完毕后，黑屏的时间。
    - 在工作目录新建一个cut.bat文件，里面输入以下内容。
```shell
ffmpeg -ss [起始时间] -t [切割长度]  -i "[输入文件名]" -c:v mpeg4 -b:v 24000k -r 30 -s 1280x720 -acodec aac -strict -2 -ac 2 -ab 256k -ar 44100 -f mp4 "[输出文件名]"
pause
```
    - 每次切割都需要更改命令中的4个参数：
        例：把 **“D:\kirara\gochiusa\1_5.mp4"** 的 **4分50秒** ～ **5分30秒** 的部分切割出来，
        切割后的视频名字是 **“D:\kirara\gochiusa\0003.mp4"** 则应该按如下填写：

        * **起始时间**：要切割的起始时间（秒），本例中应该填入290
        * **切割长度**：要切割的视频长度（秒），本例中应该填入40
        * **输入文件名**：原视频文件名的完整路径，本例中应该填入"D:\kirara\gochiusa\1_5.mp4"
        * **输出文件名**：切割后的文件的完整路径，本例中应该填入"D:\kirara\gochiusa\0003.mp4"
        填写好后，双击cut.bat即可开始切割。

# 2. 提取字幕文件（Analyse）

1. 把切割出来的视频文件放在一个文件夹，把该文件夹移动到**工作目录**。
把**该文件夹**拖放到`Kirafan_AutoSub.exe`上，等待出现命令提示后输入`2`并回车，即可开始提取字幕。
1. 字幕提取完成后，视频文件夹内出现`autosub`文件夹，把`autosub`文件夹打包发到群共享。

# 3. 翻译（Kirafan_Editor）
1. 从这里下载[Krfss_Editor](https://github.com/kirafanautodec/Krfss_Editor)。
1. 打开Krfss_Editor，把`autosub`中的`*.krfss`文件拖放到左上角的灰色按钮，即可编辑。
    - 尽量在句子开头换行。（方便校对）

# 4. 打包（Patch）
1. 把翻译好的`*.krfss`文件复制到`autosub`文件夹里，替换掉原有的`*.krfss`。
1. 把**带有视频的整个文件夹**拖放到`Kirafan_AutoSub.exe`上，等待出现命令提示后输入`3`并回车，即可开始打包。打包完成后会生成`0001.mp4.autosubed.mp4`这样的文件。并在视频文件夹下出现标题文件`title.txt`

# 5. 制作标题（GenTitle）
1. 用记事本打开视频文件夹下的`title.txt`，修改各章节的标题，输入时遵循如下规则：

    | 原标题 | 中文标题 | 注释 |
    |  :-----: | :--------: | :---: |
    | 身体が勝手に | 身体不由自主 | 直接翻译 |
    | おかーさんと一緒 その１ | 跟妈妈一起 其一 | その１→其一 |
    | アルシーヴを守る盾 イントロ | 阿尔希芙的守护盾 | 「イントロ」类型→直接翻译标题 |
    | アルシーヴを守る盾 エンド | ～战斗～ | 「エンド」类型→～战斗～ |

    **参考**：如果要制作主线第七章的标题，则`title.txt`内容如下
    ```
    平常的日子 其一
    平常的日子 其二
    ～战斗～
    平常的日子 其四
    身体不由自主 
    跟妈妈一起 其一
    跟妈妈一起 其二
    ～战斗～
    社团时间！ 其二
    社团时间！ 其三
    已经硬邦邦了 其一
    已经硬邦邦了 其五
    已经硬邦邦了 其九
    准备远足 其三
    准备远足 其四
    准备远足 其五
    七贤者·薄荷 其一
    七贤者·薄荷 其四
    ～战斗～
    醒来 
    还不能结束 
    看到的是…… 
    混乱的气息 
    ```
    输入完成后，保存。

1. 把**带有视频的整个文件夹**拖放到`Kirafan_AutoSub.exe`上，等待出现命令提示后输入`4`并回车，即可生成各章节的标题。
1. 这一步还会生成一个`videolist.txt`，这个文件将在合成视频的时候用到


# 6. 加OPED（Convert）（可选）
1. 根据剧情需要，从网上下载需要嵌入的OP和ED文件。
1. 这些视频是需要转换格式后才能和制作好的翻译视频连接。
1. 把需要转换的视频放到拖动到`Kirafan_AutoSub.exe`上，等待出现命令提示后输入`6`并回车，视频会被转换成`原视频名字.cvt.mp4`。
1. 把转换好的视频放到翻译好的视频同一个**视频文件夹**下。

# 7. 连接成一个视频文件（Concat）

1. 打开**视频文件夹**下的`videolist.txt`文件
    ```
    file '0001.title.mp4'
    file '0001.mp4.autosubed.mp4'
    file '0002.title.mp4'
    file '0002.mp4.autosubed.mp4'
    ......
    ```
    这个文件定义了合成顺序，比如说想要在第一节后第二节前插入op，则改为
    ```
    file '0001.title.mp4'
    file '0001.mp4.autosubed.mp4'
    file 'op.mp4.cvt.mp4'
    file '0002.title.mp4'
    file '0002.mp4.autosubed.mp4'
    ......
    ```
1. 把**视频文件夹**拖放到`Kirafan_AutoSub.exe`上，等待出现命令提示后输入`5`并回车，会生成最终视频`output.mp4`
