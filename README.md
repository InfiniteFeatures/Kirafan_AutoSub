# きららファンタジア字幕置換ツール
# Kirara Fantasia Auto Subtitle Patcher

## What is it?
This is a toolset for replacing the original Japanese text of Kirara Fantasia's story video into other languages.  
きららファンタジアの字幕を抽出し、文字部分を差し替えるツールである。  
Sample ouput:(generated by ver2.0)  
効果例：
- English Subtitled:
  [![IMAGE ALT TEXT](http://img.youtube.com/vi/Z8BytfESak0/0.jpg)](https://www.youtube.com/embed/Z8BytfESak0 "CameraMaster")
- Korean Subtitled:
  [![IMAGE ALT TEXT](http://img.youtube.com/vi/_6IlXAgpsEs/0.jpg)](https://www.youtube.com/embed/_6IlXAgpsEs "CameraMaster")

## Tutorial
[日本語版はここ](https://github.com/kirafanautodec/Kirafan_AutoSub/blob/master/README_JP.md)  
[中文说明看此处](https://github.com/kirafanautodec/Kirafan_AutoSub/blob/master/README_CN.md)

### Installiton
- If you are using windows, download a [pre-built binaries (v8.1.1)](https://drive.google.com/file/d/1XyLcQZ8_95fTh6oWK-5cxKNMgeG-9ifB).  
- If you are using Linux or MacOS, clone this repository to a clean directory.  
And install the dependences below:  
    - python (version 3)
    - python libraries
        - pillow
        - numpy
        - opencv-python
    - ffmpeg  

### Usage
1. Record  
Record a Kirara Fantasia story video, and copy it to an empty folder of your PC.
    - The folder name and video names **must not** include any **non-ansi** characters.
    - It is recommend to record by iOS built-in recording function.
    - You should turn on audio and check if audio is recorded.
    - When recording, make sure to include the first **transition** from 図書館 to Story, since transition will be an important sign for detecting start and end of each section.
    - Click **Auto Button** after the first sentence of section are shown fully.
    - You can record all videos of one chapter continually, since this tool will crop them automatically, but we recommend to record 5 ~ 10 videos at one time.
1. Crop  
Drag the record video into Kirafan_AutoSub.exe, and select 1 (Crop).
    - on Linux, run `python AutoSub.py <video_file>` instead.
    - This procedure will detect transition between sections and automatically seperate them.
    - It will create a folder named `<video_file>_seq_video`, and the seperated sections are named `0001.mp4`, `0002.mp4` and so on.
    - In case you recorded 1~5.mp4 and 6~10.mp4, run for them respectively, and rename the videofile manually in `6~10.mp4_seq_video` to `0006.mp4`, `0007.mp4` and so on. After that copy those files into the same folder for consequence procedure.
1. Analysis and Label  
Drag the **folder** containing `0001.mp4` ... into `Kirafan_AutoSub.exe`, and select 2 (Analysis).
    - on Linux, run `python AutoSub.py <folder>` instead.
    - The program will ask your targer language, input one from `en`, `jp`, `cn`, `ko`.
    - This procedure will analysis and label texts in videos, and generate a `krfss` file and a image folder for each video in `autosub` folder.
1. Translate  
Edit those `krfss` files by **Krfss_Editor**
    - Refer the tutorial of [Krfss_Editor](https://github.com/kirafanautodec/Krfss_Editor).
1. Patch  
Drag the **folder** containing `0001.mp4` ... into `Kirafan_AutoSub.exe`, and select 3 (Patch).
    - This procedure will apply the subtile file `krfss` and automatically patch them into videos.
    - Besides, it will generate an empty `title.txt`, in which written as same lines of dummy titles as the number of videos, this file is used to generate titles for each sections.
1. Generate Title (Optional)  
    - Edit the `title.txt`, each line contains the title of each sections.
    - If you want to use a multiple line title, use `\n`. Like `Line1\nLine2`.
    - Drag the **folder** containing `0001.mp4` ... into `Kirafan_AutoSub.exe`, and select 4 (GenTitle).
    - This procedure will generate a title video of 3 seconds for each sections, and generated a `videolist.txt` file.
1. Concatenate  
    - Edit `videolist.txt` to add or remove some files to concat.
      - If you did not run **Generate Title**, create a new file named `videolist.txt` in the same folder of videos. As for the format of `videolist.txt`, refer to ffmpeg toturial of **video concatenating**. Usually it should be the format below:
    ```
    file '0001.mp4.autosubed.mp4'
    file '0002.mp4.autosubed.mp4'
    ......
    ```
    - If you want to insert Openning/Ending, convert them before you copy them and add to `videolist.txt`
      - To convert a video, drag it into `Kirafan_AutoSub.exe` and select 6 (Convert).
      - The video after convertion is named `<video_name>.cvt.mp4`.
      - In case you have to adjust aspect ratio or audio gain manually, refer to ffmpeg toturial.
    - Drag the **folder** containing `0001.mp4` ... into `Kirafan_AutoSub.exe`, and select 5 (Concat).
    - The `output.mp4` is the final video.
